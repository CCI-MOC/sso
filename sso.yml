---
- hosts: sso
  become: yes

  tasks:
  - name: Install packages
    package: name="{{ item }}" state=present
    with_items:
    - docker
    - python-docker-py
    - git

  - name: Allow Apache to connect to Keycloak
    seboolean:
      name: httpd_can_network_relay
      state: yes
      persistent: yes

  - name: Configure Apache Proxy
    template:
      src: files/sso.conf.j2
      dest: /etc/httpd/conf.d/sso.conf
    notify:
    - httpd_restart

  - name: Start services
    service: name="{{ item }}" state=started
    with_items:
    - docker
    - httpd

  - name: Pull the Keycloak image
    docker_image:
      name: "jboss/keycloak:{{ keycloak_version }}"
    tags: container

  - name: Pull the MOC theme
    git:
      repo: 'https://github.com/knikolla/keycloak-theme-moc.git'
      dest: /root/keycloak-theme-moc

  - name: Set context on theme files
    file:
      path: /root/keycloak-theme-moc
      setype: svirt_sandbox_file_t
      recurse: yes

  - name: Re-create a keycloak container
    docker_container:
      name: keycloak
      image: jboss/keycloak:4.8.3.Final
      state: started
      restart: yes
      recreate: yes
      network_mode: host
      command: >
        -c standalone-ha.xml \
        -b 0.0.0.0 \
        -Djboss.bind.address.private="{{ ansible_eth0.ipv4.address }}"
      volumes:
      - /root/keycloak-theme-moc/moc:/opt/jboss/keycloak/themes/moc
      - /root/keycloak-theme-moc/moc-base:/opt/jboss/keycloak/themes/moc-base
      env:
        PROXY_ADDRESS_FORWARDING: "true"
        DB_VENDOR: mariadb
        DB_DATABASE: keycloak
        DB_USER: keycloak
        DB_PASSWORD: "{{ db_password }}"
        DB_ADDR: "127.0.0.1"
        DB_PORT: "3306"
        KEYCLOAK_USER: admin
        KEYCLOAK_PASSWORD: "{{ password }}"
        JAVA_OPTS: "-server -Xms128m -Xmx1024m -XX:MetaspaceSize=128M -XX:MaxMetaspaceSize=512m -Djava.net.preferIPv4Stack=true -Djboss.modules.system.pkgs=org.jboss.byteman -Djava.awt.headless=true"
    tags: run

  handlers:
  - name: httpd_restart
    service: name=httpd state=restarted
    become: yes
